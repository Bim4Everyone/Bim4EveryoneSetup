name: release

on:
  # on pull_request to master
  pull_request:
    branches:
      - master
  
  # manual
  workflow_dispatch:
  
  # every month on the first day
  schedule:
    - cron: '0 0 1 * *'

env:
  release_branch: "refs/heads/master"

jobs:
  build:
    name: build
    runs-on: windows-latest
    outputs:
      release_name: ${{ fromJSON(steps.publish-release.outputs.assets)[0].name }}
      release_download_url: ${{ fromJSON(steps.publish-release.outputs.assets)[0].browser_download_url }}
    steps:
      - uses: actions/checkout@v4
      
      # Install the .NET 8.0 workload
      - name: Install .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      
      # Install  MSBuild to the PATH: https://github.com/microsoft/setup-msbuild
      - name: Install MSBuild.exe
        uses: microsoft/setup-msbuild@v2

      # Install wix: https://wixtoolset.org/docs/intro/
      - name: Install WIX Tool
        run: dotnet tool install --global wix

      # Build project: https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-build
      - name: Build
        run: dotnet build -c Release
      
      # Get msi version
      - name: Get MSI Version
        id: current-date
        uses: juliangruber/read-file-action@v1
        with:
          path: bin/msi_version.txt
      
      # Upload the MSIX package: https://github.com/marketplace/actions/upload-a-build-artifact
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Bim4Everyone
          path: bin/Bim4Everyone_${{ steps.current-date.outputs.content }}.msi
      
      # Publish release: https://github.com/softprops/action-gh-release
      - name: Publish Release
        id: publish-release
        if: github.ref == env.release_branch
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.current-date.outputs.content }}
          name: Bim4Everyone ${{ steps.current-date.outputs.content }}
          draft: true
          prerelease: false
          files: |
            bin/Bim4Everyone_${{ steps.current-date.outputs.content }}.msi
          body: |
            ## üÜï –û–±–Ω–æ–≤–ª–µ–Ω —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Bim4Everyone 
  
            [![GitHub all releases](https://img.shields.io/github/downloads/Bim4Everyone/Bim4EveryoneSetup/total)](https://github.com/Bim4Everyone/Bim4EveryoneSetup/releases/latest)
  
            [![Telegram News](https://img.shields.io/badge/Telegram-News-blue.svg) ](https://t.me/bim4everyone_news)
            [![Telegram Group](https://img.shields.io/badge/Telegram-Group-blue.svg)](https://t.me/bim4everyone_group)
            [![Telegram Discuss](https://img.shields.io/badge/Telegram-Discuss-blue.svg)](https://t.me/bim4everyone_discuss)
            
            Bim4Everyone - —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–Ω–∞—è –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ Autodesk Revit.

  notificate:
    concurrency: ci-${{ github.ref }}
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      # Telegram Notify: https://github.com/appleboy/telegram-action/
      - name: Telegram Notify
        if: github.ref == env.release_branch
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            üëã *–û–±–Ω–æ–≤–ª–µ–Ω —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Bim4Everyone*
            
            ‚¨áÔ∏è [–°–∫–∞—á–∞—Ç—å](https://github.com/Bim4Everyone/Bim4EveryoneSetup/releases/latest)
            üì∞ [Telegram News](https://t.me/bim4everyone_news)
            üë• [Telegram Group](https://t.me/bim4everyone_group)
            üôä [Telegram Discuss](https://t.me/bim4everyone_discuss)
            
            *Bim4Everyone* - —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–Ω–∞—è –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ Autodesk Revit.
          